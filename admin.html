<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timofeyev — Панель управления</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ═══════════════════════════════════════════════
   VARIABLES & RESET
═══════════════════════════════════════════════ */
:root {
  --bg:         #111111;
  --surface:    #1a1a1a;
  --card:       #222222;
  --card2:      #2a2a2a;
  --border:     rgba(255,255,255,0.07);
  --accent:     #ffd84d;
  --accent-dim: rgba(255,216,77,0.12);
  --green:      #34c759;
  --green-dim:  rgba(52,199,89,0.12);
  --red:        #ff4444;
  --red-dim:    rgba(255,68,68,0.12);
  --orange:     #ff9500;
  --orange-dim: rgba(255,149,0,0.12);
  --text:       #f0f0f0;
  --muted:      rgba(255,255,255,0.4);
  --radius:     16px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  height: 100%;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 15px;
  -webkit-font-smoothing: antialiased;
}
button { font-family: inherit; cursor: pointer; border: none; outline: none; }
input  { font-family: inherit; outline: none; border: none; background: none; }
a { color: inherit; text-decoration: none; }

/* ═══════════════════════════════════════════════
   UTILITY
═══════════════════════════════════════════════ */
.hidden { display: none !important; }
.spin { animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:none; } }
.fade-in { animation: fadeIn 0.35s ease both; }

/* ═══════════════════════════════════════════════
   LOGIN SCREEN
═══════════════════════════════════════════════ */
#loginScreen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background:
    radial-gradient(ellipse 60% 40% at 70% 20%, rgba(255,216,77,0.06) 0%, transparent 60%),
    var(--bg);
}
.login-box {
  width: 100%;
  max-width: 400px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 40px 36px;
}
.login-brand {
  font-family: 'Unbounded', sans-serif;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
}
.login-brand span {
  color: var(--accent);
}
.login-subtitle {
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 32px;
}
.login-step { animation: fadeIn 0.3s ease both; }
.login-label {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}
.login-input-wrap {
  position: relative;
  margin-bottom: 16px;
}
.login-input {
  width: 100%;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  font-size: 16px;
  color: var(--text);
  transition: border-color 0.2s;
}
.login-input:focus { border-color: var(--accent); }
.login-input::placeholder { color: var(--muted); }
.login-phone-prefix {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  color: var(--muted);
  pointer-events: none;
}
.login-input.with-prefix { padding-left: 40px; }

.otp-row {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}
.otp-digit {
  flex: 1;
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  height: 56px;
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  transition: border-color 0.2s;
}
.otp-digit:focus { border-color: var(--accent); }

.login-btn {
  width: 100%;
  background: var(--accent);
  color: #111;
  font-weight: 700;
  font-size: 15px;
  border-radius: 12px;
  padding: 15px;
  transition: opacity 0.2s, transform 0.1s;
}
.login-btn:hover  { opacity: 0.9; }
.login-btn:active { transform: scale(0.98); }
.login-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.login-resend {
  background: none;
  color: var(--muted);
  font-size: 13px;
  width: 100%;
  padding: 12px;
  margin-top: 4px;
  transition: color 0.2s;
}
.login-resend:not(:disabled):hover { color: var(--text); }

.login-error {
  background: var(--red-dim);
  border: 1px solid rgba(255,68,68,0.25);
  color: var(--red);
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 13px;
  margin-bottom: 14px;
}

.login-back {
  background: none;
  color: var(--muted);
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 24px;
  transition: color 0.2s;
}
.login-back:hover { color: var(--text); }

.login-hint {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}

/* ═══════════════════════════════════════════════
   MAIN LAYOUT
═══════════════════════════════════════════════ */
#mainScreen {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 240px;
  flex-shrink: 0;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 100;
  transition: transform 0.3s ease;
}
.sidebar-brand {
  padding: 28px 24px 20px;
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.3px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-brand span { color: var(--accent); }
.sidebar-admin-badge {
  font-family: 'Inter', sans-serif;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  margin-top: 2px;
}

.sidebar-nav {
  flex: 1;
  padding: 16px 12px;
  overflow-y: auto;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 12px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  margin-bottom: 2px;
  position: relative;
}
.nav-item:hover { background: var(--card); color: var(--text); }
.nav-item.active { background: var(--accent-dim); color: var(--accent); }
.nav-item i { width: 18px; text-align: center; font-size: 15px; }
.nav-badge {
  margin-left: auto;
  background: var(--red);
  color: white;
  font-size: 11px;
  font-weight: 700;
  border-radius: 99px;
  padding: 1px 7px;
  min-width: 20px;
  text-align: center;
}
.nav-section-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  padding: 16px 12px 6px;
}

.sidebar-footer {
  padding: 16px 12px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-user {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 10px;
}
.sidebar-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  color: var(--accent);
  font-weight: 700;
  flex-shrink: 0;
}
.sidebar-user-name { font-size: 13px; font-weight: 500; }
.sidebar-user-role { font-size: 11px; color: var(--muted); }
.logout-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
  padding: 9px 10px;
  border-radius: 10px;
  font-size: 13px;
  color: var(--muted);
  background: none;
  margin-top: 4px;
  transition: background 0.15s, color 0.15s;
}
.logout-btn:hover { background: var(--card); color: var(--red); }

/* Content */
.content {
  margin-left: 240px;
  flex: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
.content-header {
  padding: 28px 32px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-shrink: 0;
}
.content-title {
  font-family: 'Unbounded', sans-serif;
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.3px;
}
.content-body {
  padding: 24px 32px 40px;
  flex: 1;
}

/* Hamburger for mobile */
.mobile-menu-btn {
  display: none;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: var(--card);
  border-radius: 10px;
  font-size: 16px;
  color: var(--text);
  cursor: pointer;
}

/* ═══════════════════════════════════════════════
   PAGES
═══════════════════════════════════════════════ */
.page { display: none; }
.page.active { display: block; }

/* ═══════════════════════════════════════════════
   STATS CARDS
═══════════════════════════════════════════════ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: border-color 0.2s;
}
.stat-card:hover { border-color: rgba(255,255,255,0.14); }
.stat-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 15px;
  margin-bottom: 14px;
}
.stat-icon.yellow { background: var(--accent-dim); color: var(--accent); }
.stat-icon.green  { background: var(--green-dim);  color: var(--green);  }
.stat-icon.red    { background: var(--red-dim);    color: var(--red);    }
.stat-icon.blue   { background: rgba(64,156,255,0.12); color: #409cff; }
.stat-icon.orange { background: var(--orange-dim); color: var(--orange); }

.stat-value {
  font-family: 'Unbounded', sans-serif;
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 6px;
}
.stat-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

/* ═══════════════════════════════════════════════
   SECTION HEADER
═══════════════════════════════════════════════ */
.section-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 16px;
}
.section-title {
  font-family: 'Unbounded', sans-serif;
  font-size: 15px;
  font-weight: 600;
}
.section-badge {
  font-size: 12px;
  font-weight: 600;
  background: var(--orange-dim);
  color: var(--orange);
  border-radius: 99px;
  padding: 3px 10px;
}
.section-badge.green { background: var(--green-dim); color: var(--green); }
.btn-sm {
  font-size: 13px;
  font-weight: 600;
  padding: 7px 14px;
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.15s;
}
.btn-sm:hover { background: var(--card2); }

/* ═══════════════════════════════════════════════
   DRIVER CARDS
═══════════════════════════════════════════════ */
.driver-cards { display: flex; flex-direction: column; gap: 12px; }

.driver-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  transition: border-color 0.2s;
  animation: fadeIn 0.3s ease both;
}
.driver-card:hover { border-color: rgba(255,255,255,0.12); }

.driver-card-top {
  display: flex;
  align-items: flex-start;
  gap: 14px;
  margin-bottom: 16px;
}
.driver-avatar {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  background: var(--accent-dim);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Unbounded', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--accent);
  flex-shrink: 0;
}
.driver-info { flex: 1; min-width: 0; }
.driver-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.driver-phone { font-size: 13px; color: var(--muted); }
.driver-date  { font-size: 12px; color: var(--muted); margin-left: auto; flex-shrink: 0; white-space: nowrap; }

.driver-car-info {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}
.car-detail {
  background: var(--card);
  border-radius: 10px;
  padding: 10px 12px;
}
.car-detail-label { font-size: 10px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px; }
.car-detail-value { font-size: 14px; font-weight: 500; }

.driver-status-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 99px;
  padding: 4px 12px;
}
.status-badge.pending  { background: var(--orange-dim); color: var(--orange); }
.status-badge.approved { background: var(--green-dim);  color: var(--green); }
.status-badge.rejected { background: var(--red-dim);    color: var(--red); }
.status-badge.suspended { background: rgba(255,255,255,0.07); color: var(--muted); }

.driver-class-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  font-weight: 500;
  background: var(--card);
  border-radius: 99px;
  padding: 4px 12px;
  color: var(--muted);
}

.driver-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.action-btn {
  flex: 1;
  min-width: 100px;
  padding: 11px 16px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 7px;
  transition: opacity 0.2s, transform 0.1s;
}
.action-btn:active { transform: scale(0.97); }
.action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-approve  { background: var(--green);  color: #0a0a0a; }
.btn-reject   { background: var(--red-dim); color: var(--red); border: 1px solid rgba(255,68,68,0.2); }
.btn-suspend  { background: var(--card);  color: var(--muted); }
.btn-approve:hover:not(:disabled) { opacity: 0.88; }
.btn-reject:hover:not(:disabled)  { background: rgba(255,68,68,0.2); }

/* ═══════════════════════════════════════════════
   EMPTY STATE
═══════════════════════════════════════════════ */
.empty-state {
  text-align: center;
  padding: 60px 24px;
  color: var(--muted);
}
.empty-state i { font-size: 40px; margin-bottom: 16px; opacity: 0.3; display: block; }
.empty-state p { font-size: 15px; }

/* ═══════════════════════════════════════════════
   FILTERS
═══════════════════════════════════════════════ */
.filter-tabs {
  display: flex;
  gap: 4px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 20px;
  width: fit-content;
}
.filter-tab {
  padding: 7px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  background: none;
  transition: background 0.15s, color 0.15s;
  cursor: pointer;
}
.filter-tab.active { background: var(--card2); color: var(--text); }
.filter-tab:hover:not(.active) { color: var(--text); }

/* ═══════════════════════════════════════════════
   LOADING
═══════════════════════════════════════════════ */
.loading-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 40px;
  color: var(--muted);
  font-size: 14px;
}

/* ═══════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════ */
#toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 14px;
  font-weight: 500;
  padding: 12px 20px;
  border-radius: 12px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s, transform 0.25s;
  z-index: 9999;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
#toast.success i { color: var(--green); }
#toast.error i { color: var(--red); }

/* ═══════════════════════════════════════════════
   CONFIRM DIALOG
═══════════════════════════════════════════════ */
.dialog-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 24px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}
.dialog-overlay.open { opacity: 1; pointer-events: auto; }
.dialog-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  width: 100%;
  max-width: 360px;
  transform: scale(0.95);
  transition: transform 0.2s;
}
.dialog-overlay.open .dialog-box { transform: scale(1); }
.dialog-icon {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  margin-bottom: 18px;
}
.dialog-icon.approve { background: var(--green-dim); color: var(--green); }
.dialog-icon.reject  { background: var(--red-dim);   color: var(--red);  }
.dialog-icon.suspend { background: var(--card);       color: var(--muted); }
.dialog-title {
  font-family: 'Unbounded', sans-serif;
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 8px;
}
.dialog-text { font-size: 14px; color: var(--muted); line-height: 1.5; margin-bottom: 24px; }
.dialog-name { color: var(--text); font-weight: 600; }
.dialog-actions { display: flex; gap: 8px; }
.dialog-actions button {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  transition: opacity 0.2s;
}
.dialog-actions button:hover { opacity: 0.85; }
.btn-cancel-dialog { background: var(--card); color: var(--muted); }
.btn-confirm-approve { background: var(--green); color: #0a0a0a; }
.btn-confirm-reject  { background: var(--red); color: white; }
.btn-confirm-suspend { background: var(--card2); color: var(--text); }

/* ═══════════════════════════════════════════════
   RESPONSIVE
═══════════════════════════════════════════════ */
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .sidebar.mobile-open {
    transform: translateX(0);
  }
  .content {
    margin-left: 0;
  }
  .content-header {
    padding: 20px 20px 0;
  }
  .content-body {
    padding: 16px 20px 32px;
  }
  .mobile-menu-btn {
    display: flex;
  }
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .driver-car-info {
    grid-template-columns: repeat(2, 1fr);
  }
  .sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 99;
    display: none;
  }
  .sidebar-overlay.open { display: block; }
}

/* ── Orders page ─────────────────────────────────── */
.order-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 10px;
  cursor: default;
  animation: fadeIn .25s ease both;
}
.order-card-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 8px;
}
.order-id { font-size: 13px; font-weight: 600; color: var(--muted); }
.order-status-badge {
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 20px;
  letter-spacing: .04em;
  text-transform: uppercase;
}
.s-pending    { background: var(--orange-dim); color: var(--orange); }
.s-accepted   { background: var(--green-dim);  color: var(--green); }
.s-arriving   { background: var(--green-dim);  color: var(--green); }
.s-in_progress{ background: rgba(0,122,255,.15); color: #007aff; }
.s-completed  { background: var(--green-dim);  color: var(--green); }
.s-cancelled  { background: var(--red-dim);    color: var(--red); }
.order-route { display: flex; gap: 8px; flex-direction: column; margin-bottom: 10px; }
.order-route-row { display: flex; gap: 8px; align-items: flex-start; }
.order-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.order-addr { font-size: 13px; color: var(--text); line-height: 1.4; }
.order-meta { display: flex; gap: 16px; flex-wrap: wrap; }
.order-meta-item { font-size: 12px; color: var(--muted); }
.order-meta-item strong { color: var(--text); }
.order-price { font-size: 16px; font-weight: 700; color: var(--accent); }
.page-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.page-title { font-family: 'Unbounded', sans-serif; font-size: 18px; font-weight: 700; }
.btn-refresh { background: var(--card); border: 1px solid var(--border); color: var(--muted); padding: 8px 12px; border-radius: 10px; cursor: pointer; }
.btn-refresh:hover { color: var(--text); }
.filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.pagination-row { display: flex; gap: 8px; justify-content: center; padding: 16px 0; }
.page-btn { background: var(--card); border: 1px solid var(--border); color: var(--muted); padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 13px; }
.page-btn.active { background: var(--accent); color: #141414; border-color: transparent; font-weight: 700; }
.page-btn:hover:not(.active) { color: var(--text); }

</style>
</head>
<body>

<!-- ═══════════════════════════════════════════
     ЭКРАН ВХОДА
══════════════════════════════════════════════ -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-brand">Timofeyev <span>Admin</span></div>
    <div class="login-subtitle">Панель управления сервисом</div>

    <!-- Ошибка -->
    <div id="loginError" class="login-error hidden"></div>

    <!-- ШАГ 1: Телефон -->
    <div id="loginStep1" class="login-step">
      <div class="login-label">Номер телефона</div>
      <div class="login-input-wrap">
        <span class="login-phone-prefix">+7</span>
        <input type="tel" id="loginPhone" class="login-input with-prefix"
          placeholder="(700) 000-00-00" maxlength="15"
          oninput="formatLoginPhone(this)"
          onkeydown="if(event.key==='Enter') loginSendOtp()">
      </div>
      <button class="login-btn" id="loginSendBtn" onclick="loginSendOtp()">
        Получить код
      </button>
    </div>

    <!-- ШАГ 2: OTP -->
    <div id="loginStep2" class="login-step hidden">
      <button class="login-back" onclick="loginGoBack()">
        <i class="fas fa-arrow-left"></i> Назад
      </button>
      <div class="login-label">Код из SMS</div>
      <div class="otp-row">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad0" maxlength="1"
          oninput="adminOtpInput(this,0)" onkeydown="adminOtpKey(this,0,event)">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad1" maxlength="1"
          oninput="adminOtpInput(this,1)" onkeydown="adminOtpKey(this,1,event)">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad2" maxlength="1"
          oninput="adminOtpInput(this,2)" onkeydown="adminOtpKey(this,2,event)">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad3" maxlength="1"
          oninput="adminOtpInput(this,3)" onkeydown="adminOtpKey(this,3,event)">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad4" maxlength="1"
          oninput="adminOtpInput(this,4)" onkeydown="adminOtpKey(this,4,event)">
        <input type="text" inputmode="numeric" class="otp-digit" id="ad5" maxlength="1"
          oninput="adminOtpInput(this,5)" onkeydown="adminOtpKey(this,5,event)">
      </div>
      <button class="login-btn" id="loginVerifyBtn" onclick="loginVerifyOtp()">
        Войти
      </button>
      <button class="login-resend" id="loginResendBtn" disabled onclick="loginResend()">
        Повторить через <span id="loginResendCount">60</span> сек
      </button>
      <div class="login-hint">Код отправлен на <span id="loginPhoneShow"></span></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════
     ГЛАВНЫЙ ЭКРАН
══════════════════════════════════════════════ -->
<div id="mainScreen" class="hidden">

  <!-- Overlay для мобильного меню -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      Timofeyev <span>Admin</span>
      <div class="sidebar-admin-badge">Панель управления</div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section-label">Главное</div>
      <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
        <i class="fas fa-chart-pie"></i>
        Дашборд
      </div>
      <div class="nav-item" data-page="pending" onclick="showPage('pending')">
        <i class="fas fa-user-clock"></i>
        Заявки водителей
        <span class="nav-badge hidden" id="pendingBadge">0</span>
      </div>
      <div class="nav-item" data-page="drivers" onclick="showPage('drivers')">
        <i class="fas fa-steering-wheel"></i>
        Все водители
      </div>
      <div class="nav-section-label">Пользователи</div>
      <div class="nav-item" data-page="users" onclick="showPage('users')">
        <i class="fas fa-users"></i>
        Клиенты
      </div>
      <div class="nav-section-label">Операции</div>
      <div class="nav-item" data-page="orders" onclick="showPage('orders')">
        <i class="fas fa-list-check"></i>
        Все заказы
        <span class="nav-badge hidden" id="activeOrdersBadge">0</span>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-avatar" id="sidebarAvatar">A</div>
        <div>
          <div class="sidebar-user-name" id="sidebarName">Администратор</div>
          <div class="sidebar-user-role">admin</div>
        </div>
      </div>
      <button class="logout-btn" onclick="adminLogout()">
        <i class="fas fa-sign-out-alt"></i> Выйти
      </button>
    </div>
  </nav>

  <!-- Content -->
  <main class="content">
    <div class="content-header">
      <button class="mobile-menu-btn" onclick="openMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="content-title" id="pageTitle">Дашборд</div>
      <button class="btn-sm" onclick="refreshPage()">
        <i class="fas fa-sync-alt" id="refreshIcon"></i> Обновить
      </button>
    </div>
    <div class="content-body">

      <!-- ДАШБОРД -->
      <div id="page-dashboard" class="page active">
        <div class="stats-grid" id="statsGrid">
          <div class="loading-row" style="grid-column:1/-1;">
            <i class="fas fa-circle-notch spin"></i> Загрузка...
          </div>
        </div>
        <div class="section-head">
          <div class="section-title">Ожидают проверки</div>
          <span class="section-badge" id="dashPendingBadge">...</span>
        </div>
        <div id="dashPendingList" class="driver-cards">
          <div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>
        </div>
      </div>

      <!-- ЗАЯВКИ ВОДИТЕЛЕЙ -->
      <div id="page-pending" class="page">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="setDriverFilter('pending', this)">На рассмотрении</button>
          <button class="filter-tab" onclick="setDriverFilter('approved', this)">Одобренные</button>
          <button class="filter-tab" onclick="setDriverFilter('rejected', this)">Отклонённые</button>
          <button class="filter-tab" onclick="setDriverFilter('', this)">Все</button>
        </div>
        <div id="pendingList" class="driver-cards">
          <div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>
        </div>
      </div>

      <!-- ВСЕ ВОДИТЕЛИ -->
      <div id="page-drivers" class="page">
        <div class="filter-tabs">
          <button class="filter-tab active" onclick="setDriverFilter2('approved', this)">Активные</button>
          <button class="filter-tab" onclick="setDriverFilter2('suspended', this)">Приостановлены</button>
          <button class="filter-tab" onclick="setDriverFilter2('', this)">Все</button>
        </div>
        <div id="driversList" class="driver-cards">
          <div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>
        </div>
      </div>

      <!-- КЛИЕНТЫ -->

      <div id="page-orders" class="page">
        <div class="page-head">
          <h2 class="page-title">Все заказы</h2>
          <button class="btn-refresh" onclick="loadOrders()" title="Обновить"><i class="fas fa-sync-alt"></i></button>
        </div>
        <div class="filter-row" id="ordersFilterRow">
          <button class="filter-tab active" onclick="setOrderFilter('', this)">Все</button>
          <button class="filter-tab" onclick="setOrderFilter('pending', this)">Ожидают</button>
          <button class="filter-tab" onclick="setOrderFilter('accepted', this)">Приняты</button>
          <button class="filter-tab" onclick="setOrderFilter('in_progress', this)">В пути</button>
          <button class="filter-tab" onclick="setOrderFilter('completed', this)">Завершены</button>
          <button class="filter-tab" onclick="setOrderFilter('cancelled', this)">Отменены</button>
        </div>
        <div id="ordersList" class="driver-cards">
          <div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>
        </div>
        <div class="pagination-row" id="ordersPagination"></div>
      </div>
      <div id="page-users" class="page">
        <div id="usersList" class="driver-cards">
          <div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Диалог подтверждения -->
<div class="dialog-overlay" id="confirmDialog">
  <div class="dialog-box">
    <div class="dialog-icon" id="dialogIcon">
      <i class="fas fa-check" id="dialogIconI"></i>
    </div>
    <div class="dialog-title" id="dialogTitle">Подтверждение</div>
    <div class="dialog-text" id="dialogText"></div>
    <div class="dialog-actions">
      <button class="btn-cancel-dialog" onclick="closeDialog()">Отмена</button>
      <button id="dialogConfirmBtn" onclick="dialogConfirm()">Подтвердить</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"><i class="fas fa-check" id="toastIcon"></i> <span id="toastMsg"></span></div>

<script>
/* ═══════════════════════════════════════════════════════════
   CONFIG
═══════════════════════════════════════════════════════════ */
const API = 'https://calc.timofeev.kz/api';

/* ═══════════════════════════════════════════════════════════
   HTTP CLIENT
═══════════════════════════════════════════════════════════ */
async function api(method, endpoint, data = null) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' }
  };
  const token = localStorage.getItem('admin_token');
  if (token) opts.headers['Authorization'] = `Bearer ${token}`;
  if (data)  opts.body = JSON.stringify(data);
  const res  = await fetch(`${API}/${endpoint}`, opts);
  const json = await res.json();
  if (!json.success) throw { status: res.status, message: json.message };
  return json.data;
}
const GET    = (ep)      => api('GET', ep);
const POST   = (ep, d)   => api('POST', ep, d);
const PATCH  = (ep, d)   => api('PATCH', ep, d);

/* ═══════════════════════════════════════════════════════════
   AUTH STATE
═══════════════════════════════════════════════════════════ */
let adminUser   = null;
let resendTimer = null;
let loginPhone  = '';

/* ═══════════════════════════════════════════════════════════
   BOOT — проверяем сохранённый токен
═══════════════════════════════════════════════════════════ */
(async function boot() {
  const token = localStorage.getItem('admin_token');
  if (!token) return;
  try {
    const me = await GET('auth/me');
    if (me.role !== 'admin') {
      localStorage.removeItem('admin_token');
      return;
    }
    adminUser = me;
    showMain();
  } catch(e) {
    localStorage.removeItem('admin_token');
  }
})();

/* ═══════════════════════════════════════════════════════════
   LOGIN
═══════════════════════════════════════════════════════════ */
function formatLoginPhone(input) {
  const digits = input.value.replace(/\D/g, '').slice(0, 10);
  let f = '';
  if (digits.length > 0) f = '(' + digits.slice(0,3);
  if (digits.length >= 4) f += ') ' + digits.slice(3,6);
  if (digits.length >= 7) f += '-' + digits.slice(6,8);
  if (digits.length >= 9) f += '-' + digits.slice(8,10);
  input.value = f;
}

async function loginSendOtp() {
  const phoneInput = document.getElementById('loginPhone');
  const digits = phoneInput.value.replace(/\D/g,'');
  if (digits.length < 10) { showLoginError('Введите номер телефона'); return; }
  loginPhone = '+7' + digits.slice(-10);

  const btn = document.getElementById('loginSendBtn');
  btn.disabled = true; btn.textContent = 'Отправка...';
  hideLoginError();

  try {
    await POST('auth/send-otp', { phone: loginPhone });
    document.getElementById('loginPhoneShow').textContent = loginPhone;
    document.getElementById('loginStep1').classList.add('hidden');
    document.getElementById('loginStep2').classList.remove('hidden');
    document.getElementById('ad0').focus();
    startResendTimer(60);
  } catch(e) {
    showLoginError(e.message || 'Ошибка отправки');
  } finally {
    btn.disabled = false; btn.textContent = 'Получить код';
  }
}

function adminOtpInput(el, idx) {
  el.value = el.value.replace(/\D/,'').slice(-1);
  if (el.value && idx < 5) document.getElementById('ad'+(idx+1)).focus();
  const code = getAdminOtpCode();
  if (code.length === 6) setTimeout(loginVerifyOtp, 80);
}

function adminOtpKey(el, idx, e) {
  if (e.key === 'Backspace' && !el.value && idx > 0) {
    const prev = document.getElementById('ad'+(idx-1));
    prev.value = ''; prev.focus();
  }
}

function getAdminOtpCode() {
  let c = '';
  for (let i = 0; i < 6; i++) c += (document.getElementById('ad'+i).value || '');
  return c;
}

async function loginVerifyOtp() {
  const code = getAdminOtpCode();
  if (code.length < 6) return;
  const btn = document.getElementById('loginVerifyBtn');
  btn.disabled = true; btn.textContent = 'Проверяем...';
  hideLoginError();

  try {
    const data = await POST('auth/verify-otp', { phone: loginPhone, code });
    if (data.user.role !== 'admin') {
      // Не администратор — сразу выходим
      await POST('auth/logout');
      throw { message: 'Доступ только для администраторов' };
    }
    localStorage.setItem('admin_token', data.token);
    adminUser = data.user;
    showMain();
  } catch(e) {
    showLoginError(e.message || 'Неверный код');
    // Очистить поля OTP
    for (let i = 0; i < 6; i++) document.getElementById('ad'+i).value = '';
    document.getElementById('ad0').focus();
  } finally {
    btn.disabled = false; btn.textContent = 'Войти';
  }
}

function startResendTimer(seconds) {
  clearResendTimer();
  const btn   = document.getElementById('loginResendBtn');
  const count = document.getElementById('loginResendCount');
  let left = seconds;
  btn.disabled = true;
  resendTimer = setInterval(() => {
    left--;
    count.textContent = left;
    if (left <= 0) {
      clearResendTimer();
      btn.disabled = false;
      btn.textContent = 'Отправить ещё раз';
    }
  }, 1000);
}

function clearResendTimer() {
  if (resendTimer) { clearInterval(resendTimer); resendTimer = null; }
}

async function loginResend() {
  try {
    await POST('auth/send-otp', { phone: loginPhone });
    startResendTimer(60);
    for (let i = 0; i < 6; i++) document.getElementById('ad'+i).value = '';
    document.getElementById('ad0').focus();
  } catch(e) {
    showLoginError(e.message || 'Ошибка');
  }
}

function loginGoBack() {
  clearResendTimer();
  document.getElementById('loginStep2').classList.add('hidden');
  document.getElementById('loginStep1').classList.remove('hidden');
  hideLoginError();
}

function showLoginError(msg) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.classList.remove('hidden');
}
function hideLoginError() {
  document.getElementById('loginError').classList.add('hidden');
}

/* ═══════════════════════════════════════════════════════════
   MAIN SCREEN
═══════════════════════════════════════════════════════════ */
function showMain() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('mainScreen').classList.remove('hidden');

  // Показываем имя/телефон в сайдбаре
  const name = adminUser.name || adminUser.phone;
  document.getElementById('sidebarName').textContent = name;
  document.getElementById('sidebarAvatar').textContent = (name[0] || 'A').toUpperCase();

  loadDashboard();
}

async function adminLogout() {
  try { await POST('auth/logout'); } catch(e) {}
  localStorage.removeItem('admin_token');
  localStorage.removeItem('tf_token');
  localStorage.removeItem('tf_user');
  adminUser = null;
  window.location.href = 'index.html';
}

/* ═══════════════════════════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════════════════════════ */
const pageTitles = {
  dashboard: 'Дашборд',
  pending:   'Заявки водителей',
  drivers:   'Все водители',
  users:     'Клиенты',
  orders:    'Все заказы',
};
let currentPage = 'dashboard';

function showPage(name) {
  // Скрываем все страницы
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');

  // Обновляем nav
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.page === name);
  });

  document.getElementById('pageTitle').textContent = pageTitles[name] || name;
  currentPage = name;
  closeMobileMenu();

  // Загружаем данные страницы
  if (name === 'dashboard') loadDashboard();
  if (name === 'pending')   loadDrivers('pending', 'pendingList');
  if (name === 'drivers')   loadDrivers('approved', 'driversList');
  if (name === 'users')     loadUsers();
  if (name === 'orders')    loadOrders();
}

function refreshPage() {
  const icon = document.getElementById('refreshIcon');
  icon.classList.add('spin');
  setTimeout(() => icon.classList.remove('spin'), 800);
  showPage(currentPage);
}

/* ═══════════════════════════════════════════════════════════
   FILTER TABS
═══════════════════════════════════════════════════════════ */
let currentDriverFilter  = 'pending';
let currentDriverFilter2 = 'approved';

function setDriverFilter(status, el) {
  document.querySelectorAll('#page-pending .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentDriverFilter = status;
  loadDrivers(status, 'pendingList');
}

function setDriverFilter2(status, el) {
  document.querySelectorAll('#page-drivers .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  currentDriverFilter2 = status;
  loadDrivers(status, 'driversList');
}

/* ═══════════════════════════════════════════════════════════
   DASHBOARD
═══════════════════════════════════════════════════════════ */
async function loadDashboard() {
  // Статистика
  try {
    const stats = await GET('admin/stats');
    renderStats(stats);
    const pc = stats.drivers_pending || 0;
    document.getElementById('dashPendingBadge').textContent = pc + ' заявок';
    document.getElementById('dashPendingBadge').className = 'section-badge' + (pc > 0 ? '' : ' green');
    updatePendingBadge(pc);
  } catch(e) {
    document.getElementById('statsGrid').innerHTML = '<div class="loading-row">Ошибка загрузки статистики</div>';
  }

  // Заявки ожидающие
  loadDrivers('pending', 'dashPendingList');
}

function renderStats(s) {
  const grid = document.getElementById('statsGrid');
  const cards = [
    { icon: 'users',           cls: 'blue',   value: s.users_total,      label: 'Всего пользователей' },
    { icon: 'user-tie',        cls: 'yellow',  value: s.users_drivers,    label: 'Водителей' },
    { icon: 'user-clock',      cls: 'orange', value: s.drivers_pending,  label: 'Заявок на рассмотрении' },
    { icon: 'wifi',            cls: 'green',  value: s.drivers_online,   label: 'Водителей онлайн' },
    { icon: 'list-check',      cls: 'blue',   value: s.orders_total,     label: 'Всего заказов' },
    { icon: 'check-circle',    cls: 'green',  value: s.orders_completed, label: 'Завершённых заказов' },
    { icon: 'tenge-sign',      cls: 'yellow', value: fmtMoney(s.revenue_today),  label: 'Выручка сегодня (₸)' },
    { icon: 'calendar',        cls: 'yellow', value: fmtMoney(s.revenue_month),  label: 'Выручка за месяц (₸)' },
    { icon: 'user-plus',       cls: 'blue',   value: s.new_users_today,  label: 'Новых пользователей сегодня' },
    { icon: 'receipt',         cls: 'orange', value: s.new_orders_today, label: 'Новых заказов сегодня' },
  ];
  grid.innerHTML = cards.map(c => `
    <div class="stat-card fade-in">
      <div class="stat-icon ${c.cls}"><i class="fas fa-${c.icon}"></i></div>
      <div class="stat-value">${c.value}</div>
      <div class="stat-label">${c.label}</div>
    </div>
  `).join('');
}

function fmtMoney(v) {
  if (!v) return '0';
  return (+v).toLocaleString('ru-RU');
}

function updatePendingBadge(count) {
  const badge = document.getElementById('pendingBadge');
  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

/* ═══════════════════════════════════════════════════════════
   DRIVERS
═══════════════════════════════════════════════════════════ */
async function loadDrivers(status, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '<div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>';

  try {
    const endpoint = status ? `admin/drivers?status=${status}` : 'admin/drivers';
    const drivers  = await GET(endpoint);
    renderDrivers(drivers, container, status);
  } catch(e) {
    container.innerHTML = '<div class="loading-row">Ошибка загрузки</div>';
  }
}

function renderDrivers(drivers, container, filterStatus) {
  if (!drivers || drivers.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-steering-wheel"></i>
        <p>${filterStatus === 'pending' ? 'Новых заявок нет — всё проверено!' : 'Нет данных'}</p>
      </div>`;
    return;
  }

  container.innerHTML = drivers.map(d => {
    const initials = (d.name || d.phone || '?').charAt(0).toUpperCase();
    const statusLabel = { pending:'На рассмотрении', approved:'Одобрен', rejected:'Отклонён', suspended:'Приостановлен' };
    const carName = [d.car_make, d.car_model, d.car_year].filter(Boolean).join(' ') || '—';
    const classLabel = { comfort:'Комфорт', business:'Бизнес', minivan:'Минивэн', premium:'Премиум' };

    return `
      <div class="driver-card fade-in" id="dcard-${d.id}">
        <div class="driver-card-top">
          <div class="driver-avatar">${initials}</div>
          <div class="driver-info">
            <div class="driver-name">${d.name || 'Без имени'}</div>
            <div class="driver-phone">${d.phone}</div>
          </div>
          <div class="driver-date">${formatDate(d.created_at)}</div>
        </div>

        <div class="driver-car-info">
          <div class="car-detail">
            <div class="car-detail-label">Автомобиль</div>
            <div class="car-detail-value">${carName}</div>
          </div>
          <div class="car-detail">
            <div class="car-detail-label">Цвет</div>
            <div class="car-detail-value">${d.car_color || '—'}</div>
          </div>
          <div class="car-detail">
            <div class="car-detail-label">Гос. номер</div>
            <div class="car-detail-value" style="font-family:'Unbounded',sans-serif;font-size:13px;letter-spacing:0.08em;">${d.car_number || '—'}</div>
          </div>
          <div class="car-detail">
            <div class="car-detail-label">Удостоверение</div>
            <div class="car-detail-value">${d.license_number || '—'}</div>
          </div>
        </div>

        <div class="driver-status-row">
          <span class="status-badge ${d.status}">${statusLabel[d.status] || d.status}</span>
          <span class="driver-class-badge"><i class="fas fa-car" style="font-size:11px;"></i> ${classLabel[d.car_class] || d.car_class || '—'}</span>
        </div>

        <div class="driver-actions">
          ${d.status === 'pending' ? `
            <button class="action-btn btn-approve" onclick="confirmAction(${d.id}, 'approved', '${escHtml(d.name||d.phone)}')">
              <i class="fas fa-check"></i> Одобрить
            </button>
            <button class="action-btn btn-reject" onclick="confirmAction(${d.id}, 'rejected', '${escHtml(d.name||d.phone)}')">
              <i class="fas fa-times"></i> Отклонить
            </button>
          ` : ''}
          ${d.status === 'approved' ? `
            <button class="action-btn btn-suspend" onclick="confirmAction(${d.id}, 'suspended', '${escHtml(d.name||d.phone)}')">
              <i class="fas fa-pause-circle"></i> Приостановить
            </button>
          ` : ''}
          ${d.status === 'suspended' || d.status === 'rejected' ? `
            <button class="action-btn btn-approve" onclick="confirmAction(${d.id}, 'approved', '${escHtml(d.name||d.phone)}')">
              <i class="fas fa-check"></i> Активировать
            </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

/* ═══════════════════════════════════════════════════════════
   USERS
═══════════════════════════════════════════════════════════ */
async function loadUsers() {
  const container = document.getElementById('usersList');
  container.innerHTML = '<div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>';
  try {
    const data = await GET('admin/users?role=client');
    if (!data.users || data.users.length === 0) {
      container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Нет клиентов</p></div>';
      return;
    }
    container.innerHTML = data.users.map(u => {
      const initials = (u.name || u.phone).charAt(0).toUpperCase();
      return `
        <div class="driver-card fade-in">
          <div class="driver-card-top">
            <div class="driver-avatar" style="background:rgba(64,156,255,0.12);color:#409cff;">${initials}</div>
            <div class="driver-info">
              <div class="driver-name">${u.name || 'Без имени'}</div>
              <div class="driver-phone">${u.phone}</div>
            </div>
            <div class="driver-date">${formatDate(u.created_at)}</div>
          </div>
          <div class="driver-status-row">
            <span class="status-badge ${u.status === 'active' ? 'approved' : 'rejected'}">
              ${u.status === 'active' ? 'Активен' : 'Заблокирован'}
            </span>
          </div>
          <div class="driver-actions">
            ${u.status === 'active'
              ? `<button class="action-btn btn-reject" onclick="blockUser(${u.id}, '${escHtml(u.name||u.phone)}', 'blocked')">
                   <i class="fas fa-ban"></i> Заблокировать
                 </button>`
              : `<button class="action-btn btn-approve" onclick="blockUser(${u.id}, '${escHtml(u.name||u.phone)}', 'active')">
                   <i class="fas fa-check"></i> Разблокировать
                 </button>`
            }
          </div>
        </div>
      `;
    }).join('');
  } catch(e) {
    container.innerHTML = '<div class="loading-row">Ошибка загрузки</div>';
  }
}

/* ═══════════════════════════════════════════════════════════
   CONFIRM DIALOG
═══════════════════════════════════════════════════════════ */
let _pendingAction = null;

function confirmAction(driverId, newStatus, name) {
  const cfg = {
    approved: {
      iconCls: 'approve', iconI: 'fas fa-check',
      title: 'Одобрить водителя',
      text: `Вы одобряете заявку <span class="dialog-name">${name}</span>. Он получит SMS и сможет принимать заказы.`,
      btnCls: 'btn-confirm-approve', btnText: 'Одобрить'
    },
    rejected: {
      iconCls: 'reject', iconI: 'fas fa-times',
      title: 'Отклонить заявку',
      text: `Вы отклоняете заявку <span class="dialog-name">${name}</span>. Водитель будет уведомлён.`,
      btnCls: 'btn-confirm-reject', btnText: 'Отклонить'
    },
    suspended: {
      iconCls: 'suspend', iconI: 'fas fa-pause',
      title: 'Приостановить',
      text: `Водитель <span class="dialog-name">${name}</span> не сможет принимать заказы.`,
      btnCls: 'btn-confirm-suspend', btnText: 'Приостановить'
    }
  };
  const c = cfg[newStatus];
  if (!c) return;

  document.getElementById('dialogIcon').className  = `dialog-icon ${c.iconCls}`;
  document.getElementById('dialogIconI').className = c.iconI;
  document.getElementById('dialogTitle').textContent = c.title;
  document.getElementById('dialogText').innerHTML  = c.text;
  const btn = document.getElementById('dialogConfirmBtn');
  btn.className = c.btnCls;
  btn.textContent = c.btnText;

  _pendingAction = { type: 'driver', id: driverId, status: newStatus };
  document.getElementById('confirmDialog').classList.add('open');
}

function blockUser(userId, name, newStatus) {
  const isBlock = newStatus === 'blocked';
  document.getElementById('dialogIcon').className  = `dialog-icon ${isBlock ? 'reject' : 'approve'}`;
  document.getElementById('dialogIconI').className = `fas fa-${isBlock ? 'ban' : 'check'}`;
  document.getElementById('dialogTitle').textContent = isBlock ? 'Заблокировать' : 'Разблокировать';
  document.getElementById('dialogText').innerHTML  = `Пользователь <span class="dialog-name">${name}</span> будет ${isBlock ? 'заблокирован' : 'разблокирован'}.`;
  const btn = document.getElementById('dialogConfirmBtn');
  btn.className = isBlock ? 'btn-confirm-reject' : 'btn-confirm-approve';
  btn.textContent = isBlock ? 'Заблокировать' : 'Разблокировать';

  _pendingAction = { type: 'user', id: userId, status: newStatus };
  document.getElementById('confirmDialog').classList.add('open');
}

function closeDialog() {
  document.getElementById('confirmDialog').classList.remove('open');
  _pendingAction = null;
}

async function dialogConfirm() {
  if (!_pendingAction) return;
  const btn = document.getElementById('dialogConfirmBtn');
  btn.disabled = true;
  const orig = btn.textContent;
  btn.innerHTML = '<i class="fas fa-circle-notch spin"></i>';

  try {
    if (_pendingAction.type === 'driver') {
      await PATCH(`admin/drivers/${_pendingAction.id}`, { status: _pendingAction.status });
      const labels = { approved:'Водитель одобрен ✓', rejected:'Заявка отклонена', suspended:'Водитель приостановлен' };
      showToast(labels[_pendingAction.status] || 'Готово', 'success');
    } else if (_pendingAction.type === 'user') {
      await PATCH(`admin/users/${_pendingAction.id}`, { status: _pendingAction.status });
      showToast(_pendingAction.status === 'blocked' ? 'Пользователь заблокирован' : 'Пользователь разблокирован', 'success');
    }
    closeDialog();
    // Обновляем текущую страницу
    await refreshCurrent();
  } catch(e) {
    showToast(e.message || 'Ошибка', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = orig;
  }
}

async function refreshCurrent() {
  if (currentPage === 'dashboard') await loadDashboard();
  if (currentPage === 'pending')   await loadDrivers(currentDriverFilter, 'pendingList');
  if (currentPage === 'drivers')   await loadDrivers(currentDriverFilter2, 'driversList');
  if (currentPage === 'users')     await loadUsers();
}

/* ═══════════════════════════════════════════════════════════
   MOBILE MENU
═══════════════════════════════════════════════════════════ */
function openMobileMenu() {
  document.getElementById('sidebar').classList.add('mobile-open');
  document.getElementById('sidebarOverlay').classList.add('open');
}
function closeMobileMenu() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

/* ═══════════════════════════════════════════════════════════
   TOAST
═══════════════════════════════════════════════════════════ */
let _toastTimer = null;
function showToast(msg, type = 'success') {
  const el   = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const span = document.getElementById('toastMsg');
  icon.className = type === 'success' ? 'fas fa-check' : 'fas fa-exclamation-circle';
  el.className   = 'show ' + type;
  span.textContent = msg;
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

/* ═══════════════════════════════════════════════════════════
   HELPERS
═══════════════════════════════════════════════════════════ */
function formatDate(str) {
  if (!str) return '';
  const d = new Date(str);
  return d.toLocaleDateString('ru-RU', { day:'2-digit', month:'short', year:'numeric' });
}
function escHtml(str) {
  return (str||'').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// Закрыть диалог кликом на оверлей
document.getElementById('confirmDialog').addEventListener('click', function(e) {
  if (e.target === this) closeDialog();
});


// ══════════════════════════════════════════════════════════
// ORDERS PAGE
// ══════════════════════════════════════════════════════════
let _ordersFilter = '';
let _ordersPage   = 1;

const ORDER_STATUS_TEXT = {
  pending:     'Ожидает',
  accepted:    'Принят',
  arriving:    'Водитель прибывает',
  in_progress: 'В пути',
  completed:   'Завершён',
  cancelled:   'Отменён',
};

function setOrderFilter(status, el) {
  _ordersFilter = status;
  _ordersPage   = 1;
  document.querySelectorAll('#ordersFilterRow .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  loadOrders();
}

async function loadOrders() {
  const container = document.getElementById('ordersList');
  if (!container) return;
  container.innerHTML = '<div class="loading-row"><i class="fas fa-circle-notch spin"></i> Загрузка...</div>';

  try {
    const params = { page: _ordersPage };
    if (_ordersFilter) params.status = _ordersFilter;
    const data = await api('GET', 'admin/orders?' + new URLSearchParams(params));
    renderOrders(data.orders || [], data.total || 0, data.page || 1, Math.ceil((data.total||0)/30));

    // Update badge with active count
    const activeCount = await api('GET', 'admin/orders?' + new URLSearchParams({ status: 'pending' }));
    const badge = document.getElementById('activeOrdersBadge');
    if (badge) {
      const cnt = activeCount.total || 0;
      badge.textContent = cnt;
      badge.classList.toggle('hidden', cnt === 0);
    }
  } catch (e) {
    container.innerHTML = `<div class="loading-row" style="color:var(--red)"><i class="fas fa-exclamation-circle"></i> ${e.message}</div>`;
  }
}

function renderOrders(orders, total, page, pages) {
  const container = document.getElementById('ordersList');
  const pagination = document.getElementById('ordersPagination');
  if (!container) return;

  if (!orders.length) {
    container.innerHTML = '<div class="loading-row" style="color:var(--muted)"><i class="fas fa-inbox"></i> Заказов нет</div>';
    if (pagination) pagination.innerHTML = '';
    return;
  }

  container.innerHTML = orders.map(o => {
    const stClass = 's-' + o.status;
    const stText  = ORDER_STATUS_TEXT[o.status] || o.status;
    const priceStr = o.price ? Number(o.price).toLocaleString('ru-RU') + ' ₸' : '—';
    const date = formatDate(o.created_at);

    return `
    <div class="order-card fade-in">
      <div class="order-card-head">
        <span class="order-id">#${o.id} &nbsp;•&nbsp; ${o.tariff_name || ''} &nbsp;•&nbsp; ${o.transport_class || ''}</span>
        <span class="order-status-badge ${stClass}">${stText}</span>
      </div>
      <div class="order-route">
        <div class="order-route-row">
          <div class="order-dot" style="background:#34c759"></div>
          <div class="order-addr">${escHtml(o.from_address || '—')}</div>
        </div>
        <div class="order-route-row">
          <div class="order-dot" style="background:var(--accent)"></div>
          <div class="order-addr">${escHtml(o.to_address || '—')}</div>
        </div>
      </div>
      <div class="order-meta">
        <div class="order-meta-item">Клиент: <strong>${escHtml(o.client_name || '—')}</strong> ${o.client_phone ? '&nbsp;<a href="tel:'+o.client_phone+'" style="color:var(--accent)">'+o.client_phone+'</a>' : ''}</div>
        ${o.driver_name ? `<div class="order-meta-item">Водитель: <strong>${escHtml(o.driver_name)}</strong></div>` : '<div class="order-meta-item" style="color:var(--orange)">Водитель не назначен</div>'}
        ${o.distance_km ? `<div class="order-meta-item">Расстояние: <strong>${o.distance_km} км</strong></div>` : ''}
        <div class="order-meta-item">Оплата: <strong>${o.payment_method === 'cash' ? 'Наличные' : 'Карта'}</strong></div>
        <div class="order-meta-item">Дата: <strong>${date}</strong></div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <span class="order-price">${priceStr}</span>
      </div>
    </div>`;
  }).join('');

  // Pagination
  if (pagination && pages > 1) {
    let btns = '';
    for (let i = 1; i <= pages; i++) {
      btns += `<button class="page-btn ${i===page?'active':''}" onclick="goOrdersPage(${i})">${i}</button>`;
    }
    pagination.innerHTML = btns;
  } else if (pagination) {
    pagination.innerHTML = '';
  }
}

function goOrdersPage(p) {
  _ordersPage = p;
  loadOrders();
}

</script>
</body>
</html>